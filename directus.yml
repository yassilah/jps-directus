version: 1.5
type: install
name: Directus
logo: https://icons.duckduckgo.com/ip3/directus.io.ico
homepage: https://directus.io/
description: This template will create an instance of the latest version of Directus, a headless CMS and API for custom databases.
ssl: true

settings:
  fields:  
    - caption: Admin E-mail
      type: string
      inputType: email
      default: admin@example.com
      name: ADMIN_EMAIL
      required: true
    - caption: Admin Password
      type: string
      inputType: password
      default: password
      name: ADMIN_PASSWORD
      required: true

nodes:
  - database:
    displayName: Database
    cloudlets: 8
    nodeGroup: sqldb
    nodeType: postgresql
    skipNodeEmails: true
  - load-balancer:
    displayName: Load Balancer
    cloudlets: 1
    nodeGroup: bl
    nodeType: nginx
    skipNodeEmails: true
  - cache:
    displayName: Cache
    cloudlets: 4
    nodeType: redis
    nodeGroup: cache
    skipNodeEmails: true

onInstall:
  - install:
    type: update
    name: Directus
    onInstall:
      - addNodes:
        - admin-panel:
          displayName: Admin Panel
          cloudlets: 8
          nodeGroup: cp
          nodeType: docker
          dockerName: directus/directus
          skipNodeEmails: true
          dockerTag: latest
          dockerRunCmd: node cli.js bootstrap && pm2-runtime start ecosystem.config.cjs ;
          dockerEntryPoint: /bin/sh -c
          extip: true
          dockerEnvVars:
            SECRET: ${fn.uuid}
            ADMIN_EMAIL: ${settings.ADMIN_EMAIL}
            ADMIN_PASSWORD: ${settings.ADMIN_PASSWORD}
            DB_USER: webadmin
            DB_PASSWORD: ${nodes.postgresql.password}
            DB_CLIENT: pg
            DB_HOST: ${nodes.postgresql.address}
            DB_PORT: 5432
            DB_DATABASE: postgres
            CACHE_ENABLED: true
            CACHE_AUTO_PURGE: true
            CACHE_STORE: redis
            REDIS_HOST: ${nodes.cache.address}
            REDIS_PORT: 6379
            REDIS_PASSWORD: ${nodes.cache.password}
            PUBLIC_URL: ${env.url}
  - install:
    type: update
    name: Update Nginx Configuration
    onInstall:
      - writeFile:
        nodeType: nginx
        path: ${nginx.SERVER_CONF_D}/directus.conf
        body: |
          http {
            server {
                listen 80;
                listen [::]:80;
                server_name _;
                location / {
                    proxy_pass http://${nodes.cp.address}:8055;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
          }
      - replaceInFile:
        nodeType: nginx
        path: ${nginxphp.NGINX_CONF}
        replacements: 
          - pattern: nginx-jelastic 
            replacement: conf.d/directus
  - install:
    type: update
    name: Restart Nginx
    onInstall:
      - restartService:
        nodeGroup: bl
